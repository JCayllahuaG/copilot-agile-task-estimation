name: Run When Labeled Issue Is Created

on:
  issues:
    types: [opened, labeled]

jobs:
  handle-labeled-issue:
    if: >
      github.event.action == 'opened' && 
      contains(github.event.issue.labels.*.name, 'from-jira')
    runs-on: ubuntu-latest
    steps:
      - name: Print Issue Info
        run: |
          echo "ğŸ¯ Issue Title: ${{ github.event.issue.title }}"
          echo "ğŸ“ Issue Body: ${{ github.event.issue.body }}"
          echo "ğŸ·ï¸ Labels: ${{ toJson(github.event.issue.labels) }}"
    
      - name: Query GitHub GraphQL for Issue ID
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          OWNER=$(echo "${{ github.repository }}" | cut -d'/' -f1)
          REPO=$(echo "${{ github.repository }}" | cut -d'/' -f2)

          # Build GraphQL query
          QUERY=$(cat <<EOF
          query {
            repository(owner: "$OWNER", name: "$REPO") {
              issue(number: $ISSUE_NUMBER) {
                id
                title
              }
            }
          }
          EOF
          )

          # Escape query for JSON
          ESCAPED_QUERY=$(echo "$QUERY" | jq -Rs .)

          # Call GitHub GraphQL API
          RESPONSE=$(curl -s -X POST https://api.github.com/graphql \
            -H "Authorization: bearer $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"query\": $ESCAPED_QUERY}")

          echo "GraphQL Response: $RESPONSE"
